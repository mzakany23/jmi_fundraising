{% extends 'fundraiser/index.html' %}
{% load staticfiles %}

{% block checkout %}
<!-- ==========================
      ESHOP - START 
    =========================== -->
    <section class="content bg-color-2" id="eshop">
      
            
            <div class="shopping-cart">
                <h3>Item Summary</h3>
                
                {% for item in session_fundraiser.selections %}
                <!-- SHOPPING CART ITEM -->
                <div class="shopping-cart-item">
                    <div class="row">
                        <div class="col-md-2">
                            <img src="{{ settings.server }}/media/{{ item.product.image }}" class="img-responsive" alt="">
                        </div>
                        <div class="col-md-5">
                            <h3>{{ item.product.title }}</h3>
                        </div>
                        <div class="col-md-1">
                            <p class="quantity">{{ item.quantity }}</p>
                        </div>
                        <div class="col-md-2">
                            <!-- <p class="small-price">$3 per jar</p> -->
                        </div>
                        <div class="col-md-2">
                            <p class="total-price">$3/jar</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- ==========================
      PORTFOLIO POST - START 
    =========================== -->
    
      
        <!-- BLOG POST -->
        <h3>Payment Method</h3>
        <div id='checkoutErrors' style="display: none;"class="alert alert-danger alert-dismissible" role="alert">
          <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          Make sure to select a payment type!
        </div>

        <div class="shopping-cart">
                <form class="form-payment" action="{% url 'checkout' %}">
                    <fieldset>
                        <div class="row">
                            <div class="col-sm-3">
                                <div class="form-group">

                                    <div class="radio"><label><input type="radio" name="paymentRadio" id="paymentmethod1" value="credit">Credit Card</label></div>
                                </div>
                            </div>
                            
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <div class="radio"><label><input type="radio" name="paymentRadio" id="paymentmethod2" value="check">Check Payment</label></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style='display:none' id='creditCardForm'>{% include 'fundraiser/partials/_credit-card-form.html' %}</div>
                        <div style='display:none' id='checkPaymentForm'>{% include 'fundraiser/partials/_check_description.html' %}</div>
                        
                    </fieldset>
                
            </div>
              

    
    
    <!-- ==========================
      PORTFOLIO POST - END 
    =========================== --> 
                
                <!-- SHOPPING CART FOOTER -->
                <div class="shopping-cart-footer">
                    <div class="row">
                        <div class="col-md-5">
                            
                                <fieldset>
                                    <div class="form-group">
                                      <label for="discount">Discount Code</label>
                                        <div class="input-group">
                                         {% include 'fundraiser/partials/_discount.html' %}
                                        </div>
                                    </div>
                                </fieldset>
                            
                        </div>
                        <div class="col-md-2 col-md-offset-2 col-xs-7">
                            <p class="total-price-title">Subtotal:</p>
                            <p class="total-price-title">Shipping:</p>
                            <!-- <p class="total-price-title">Payment fee:</p> -->
                            <p class="total-price-title">Discount:</p>
                            <p class="total-price-title">Total:</p>
                        </div>
                        <div class="col-md-3 col-xs-5">
                            <p class="total-price-title text-right">${{ session_fundraiser.shipment.pre_tax_cost }}</p>
                            <p class="total-price-title text-right">${{ session_fundraiser.shipment.shipping_cost }}</p>
                            <!-- <p class="total-price-title text-right">$5</p> -->
                            <p class="total-price-title text-right">$0</p>
                            <p class="total-price">${{ session_fundraiser.shipment.total_cost_with_shipping }}</p>
                            
                        </div>
                        <div class="col-md-5 col-md-offset-7">
                              <button id='pageSubmit'type="submit" class="btn btn-danger btn-lg btn-block">Confirm Order</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
                
        
    </section>
    <!-- ==========================
      ESHOP - END 
    =========================== --> 

{% csrf_token %}

<script type="text/javascript">
  Stripe.setPublishableKey({{ stripe_api_key.pwd }});
</script>
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script type="text/javascript">

$(function(){
  
  var state;

  $('#paymentmethod1').change(function(e){
    $('#checkPaymentForm').hide()
    state = $('#paymentmethod1').val()
    if (state == 'credit') {
      $('#creditCardForm').show('slow')
    } 
  });

  $('#paymentmethod2').change(function(e){
    state = $('#paymentmethod2').val()
    if (state == 'check') {
      $('#creditCardForm').hide()
      $('#checkPaymentForm').show('slow')
    }else{
      $('#checkPaymentForm').slideUp();
    }
  });  



    $('#pageSubmit').click(function(e){
      e.preventDefault();
      
      if (state == 'credit') {
        // process stripe
      } else if (state == 'check') {
        csrf_token = $("input[name=csrfmiddlewaretoken]").val()
        $.ajax({
          type: "POST",
          url: "/process-fundraiser/",
          dataType: 'json',
          data: {
            csrfmiddlewaretoken: csrf_token,
            type: 'check'
          },
          success: function(data){
            window.location = "{% url 'process_checkout' %}";
          },
        });
        return false;
      } else {
          $('#checkoutErrors').show('slow');
      }
      
    })

});

</script>
{% endblock %}